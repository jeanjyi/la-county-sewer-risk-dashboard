<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA County Sewer Pipe Risk Dashboard</title>

    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: clamp(15px, 2vh, 40px) clamp(20px, 3vw, 60px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: clamp(20px, 2.5vw, 48px);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header p {
            font-size: clamp(12px, 1.2vw, 24px);
            opacity: 0.9;
        }

        .nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            padding: 0 clamp(20px, 3vw, 60px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .nav-btn {
            padding: clamp(12px, 1.5vh, 25px) clamp(15px, 2vw, 40px);
            background: none;
            border: none;
            cursor: pointer;
            font-size: clamp(12px, 1.2vw, 24px);
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            color: #1e3c72;
            background: #f8f9fa;
        }

        .nav-btn.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .container {
            max-width: 90%;
            margin: 0 auto;
            padding: 30px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: clamp(15px, 2vw, 35px);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            border-left: 4px solid #1e3c72;
        }

        .kpi-label {
            font-size: clamp(11px, 1vw, 20px);
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: clamp(24px, 3vw, 56px);
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .kpi-subtext {
            font-size: clamp(10px, 0.9vw, 18px);
            color: #999;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .chart-title {
            font-size: clamp(14px, 1.3vw, 28px);
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        #map {
            height: 55vh;
            min-height: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-critical { background: #dc3545; color: white; }
        .badge-high { background: #fd7e14; color: white; }
        .badge-medium { background: #ffc107; color: #333; }
        .badge-low { background: #28a745; color: white; }

        .loading {
            text-align: center;
            padding: 100px;
            font-size: 18px;
            color: #666;
        }

        .footer {
            margin-top: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .methodology-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .methodology-table thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .methodology-table th {
            background: transparent;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .methodology-table td {
            padding: 12px 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .methodology-table tbody tr:nth-child(odd) {
            background: #f8f9fa;
        }

        .methodology-table tbody tr:nth-child(even) {
            background: white;
        }

        .methodology-table tbody tr:hover {
            background: #e3f2fd;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        /* Mobile Responsive Styles */
        html, body {
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .nav {
                padding: 0 5px;
                flex-wrap: wrap;
                justify-content: center;
            }

            .nav-btn {
                padding: 10px 8px;
                font-size: 11px;
                flex: 1 1 auto;
                text-align: center;
            }

            .container {
                padding: 15px;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                padding: 10px;
                max-width: 100%;
            }

            .chart-container > div {
                max-width: 100%;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .kpi-card {
                padding: 20px;
            }

            .kpi-value {
                font-size: 28px;
            }

            #map {
                height: 45vh;
                min-height: 300px;
            }

            .table-container {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            .methodology-table {
                font-size: 11px;
            }

            .methodology-table th,
            .methodology-table td {
                padding: 8px 5px;
            }

            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LA County Sewer Pipe Risk Assessment Dashboard</h1>
        <p>Predictive model identifying highest-risk infrastructure for maintenance prioritization</p>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="showPage('overview')">Executive Overview</button>
        <button class="nav-btn" onclick="showPage('map')">Geographic Analysis</button>
        <button class="nav-btn" onclick="showPage('risks')">Top Risks</button>
        <button class="nav-btn" onclick="showPage('methodology')">Methodology</button>
    </div>

    <div class="container">
        <div id="loading" class="loading">Loading data...</div>

        <!-- Overview Page -->
        <div id="overview" class="page">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Total Pipes Scored</div>
                    <div class="kpi-value" id="kpi-total">-</div>
                    <div class="kpi-subtext">50% of 7,020 SSO incidents</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">High/Critical Risk</div>
                    <div class="kpi-value" id="kpi-high">-</div>
                    <div class="kpi-subtext">Require priority attention</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Average Risk Score</div>
                    <div class="kpi-value" id="kpi-avg">-</div>
                    <div class="kpi-subtext">Scale: 18-100</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Pipes 70+ Years</div>
                    <div class="kpi-value" id="kpi-old">-</div>
                    <div class="kpi-subtext">Highest risk age group</div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">Risk Category Distribution</div>
                    <div id="chart-donut"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Age vs Risk Score</div>
                    <div id="chart-scatter"></div>
                </div>
            </div>

            <div class="chart-grid">
                <div class="chart-container">
                    <div class="chart-title">Material Distribution by Count</div>
                    <div id="chart-material-pie"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Average Risk by Material</div>
                    <div id="chart-material-bar"></div>
                </div>
            </div>
        </div>

        <!-- Map Page -->
        <div id="mapPage" class="page">
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Risk Category</label>
                    <select id="map-filter-risk" onchange="filterMap()">
                        <option value="all">All</option>
                        <option value="Critical">Critical</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Material Type</label>
                    <select id="map-filter-material" onchange="filterMap()">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Min Risk Score</label>
                    <input type="number" id="map-filter-score" min="0" max="100" value="0" onchange="filterMap()">
                </div>
            </div>
            <div id="map"></div>
        </div>

        <!-- Risks Page -->
        <div id="risksPage" class="page">
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Show Top</label>
                    <select id="top-n" onchange="updateTopRisks()">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table id="risks-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Location</th>
                            <th>City</th>
                            <th>Material</th>
                            <th>Age</th>
                            <th>Risk Score</th>
                            <th>Category</th>
                            <th>Spill Date</th>
                        </tr>
                    </thead>
                    <tbody id="risks-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Methodology Page -->
        <div id="methodology" class="page">
            <h2 style="color: #1e3c72; margin-bottom: 30px;">Model Methodology</h2>

            <!-- Model Overview -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Weighted Risk Scoring Model</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
                    <code style="font-size: 18px; color: #1e3c72;">
                        risk_score = (age_score × 0.80) + (material_score × 0.20)
                    </code>
                </div>
                <p style="line-height: 1.6;">
                    This model uses a <strong>weighted risk scoring approach</strong> with an 80/20 split between age and material factors.
                    This weighting is based on empirical research from Dallas showing pipe age has approximately 4× the predictive importance
                    of material type for sewer pipe failures.
                </p>
            </div>

            <!-- Age Scoring -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Age Scoring (80% Weight)</h3>
                <p style="line-height: 1.6; margin-bottom: 15px;">
                    Age risk is calculated using an <strong>exponential curve</strong> that reflects real-world failure patterns:
                </p>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 15px; text-align: center;">
                    <code style="font-size: 16px; color: #1e3c72;">
                        score = 20 + ((age/100)<sup>1.8</sup>) × 80
                    </code>
                </div>
                <p style="line-height: 1.6; margin-bottom: 10px;">
                    <strong>Research Basis:</strong> Isfahan study (Goodarzi 2024) documented exponential failure acceleration,
                    with failures increasing from 56 to 393 in the 40-50 year age band.
                </p>
                <p style="line-height: 1.6;">
                    <strong>Score Ranges:</strong> New pipes start at 20 (minimum risk baseline), scores accelerate exponentially
                    with age, reaching 100 at age 100+.
                </p>
            </div>

            <!-- Material Scoring -->
            <div class="card" style="margin-bottom: 30px;">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Material Scoring (20% Weight)</h3>
                <p style="line-height: 1.6; margin-bottom: 15px;">
                    Material risk is assessed across <strong>6 factors</strong>: H2S Corrosion, Root Intrusion,
                    Structural Integrity, Joint Degradation, Surface Roughness, and Expected Longevity.
                </p>
                <p style="line-height: 1.6; margin-bottom: 15px;">
                    <strong>How Overall Risk Scores Were Calculated:</strong> Each material was evaluated qualitatively across all 6 factors
                    based on industry knowledge and failure mechanism research. Factors with higher failure risk (e.g., "Very High" corrosion,
                    "Severe" joint degradation) contributed more to the overall score. Materials with multiple high-risk factors received
                    higher scores, while those with consistently low-risk ratings received lower scores.
                </p>
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="methodology-table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Overall Risk Score</th>
                                <th>H2S Corrosion Risk</th>
                                <th>Root Intrusion Risk</th>
                                <th>Structural Integrity</th>
                                <th>Joint Degradation</th>
                                <th>Surface Roughness</th>
                                <th>Expected Longevity</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Cast Iron</strong></td>
                                <td>100</td>
                                <td>Very High</td>
                                <td>High</td>
                                <td>Brittle</td>
                                <td>Severe</td>
                                <td>Moderate</td>
                                <td>50-75 years</td>
                            </tr>
                            <tr>
                                <td><strong>Concrete</strong></td>
                                <td>70</td>
                                <td>High</td>
                                <td>Moderate</td>
                                <td>Good</td>
                                <td>Moderate</td>
                                <td>Rough</td>
                                <td>50-100 years</td>
                            </tr>
                            <tr>
                                <td><strong>Steel</strong></td>
                                <td>60</td>
                                <td>High</td>
                                <td>Low</td>
                                <td>Good</td>
                                <td>Moderate</td>
                                <td>Smooth</td>
                                <td>50-75 years</td>
                            </tr>
                            <tr>
                                <td><strong>Vitrified Clay</strong></td>
                                <td>50</td>
                                <td>Low</td>
                                <td>Very High</td>
                                <td>Brittle</td>
                                <td>Severe</td>
                                <td>Smooth</td>
                                <td>75-100+ years</td>
                            </tr>
                            <tr>
                                <td><strong>Asbestos Cement</strong></td>
                                <td>36</td>
                                <td>Low</td>
                                <td>Moderate</td>
                                <td>Brittle</td>
                                <td>Moderate-High</td>
                                <td>Smooth</td>
                                <td>50-75 years</td>
                            </tr>
                            <tr>
                                <td><strong>Ductile Iron</strong></td>
                                <td>18</td>
                                <td>Low-Moderate</td>
                                <td>Low</td>
                                <td>Excellent</td>
                                <td>Low</td>
                                <td>Smooth</td>
                                <td>100+ years</td>
                            </tr>
                            <tr>
                                <td><strong>PVC</strong></td>
                                <td>10</td>
                                <td>Immune</td>
                                <td>Very Low</td>
                                <td>Flexible</td>
                                <td>Very Low</td>
                                <td>Very Smooth</td>
                                <td>100+ years</td>
                            </tr>
                            <tr>
                                <td><strong>HDPE</strong></td>
                                <td>10</td>
                                <td>Immune</td>
                                <td>Very Low</td>
                                <td>Flexible</td>
                                <td>Very Low</td>
                                <td>Very Smooth</td>
                                <td>100+ years</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Research Foundation -->
            <div class="card">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">Research Foundation</h3>
                <p style="line-height: 1.6; margin-bottom: 10px;">
                    <strong><a href="https://doi.org/10.1061/(ASCE)IS.1943-555X.0000680" target="_blank" style="color: #1e3c72;">Dallas Study (Atambo 2022)</a>:</strong> MLR + ANN models, 75-85% accuracy.
                    Age showed 100% normalized importance vs. 25% for material (4:1 ratio).
                </p>
                <p style="line-height: 1.6; margin-bottom: 10px;">
                    <strong><a href="https://doi.org/10.3390/w16010056" target="_blank" style="color: #1e3c72;">Isfahan Study (Goodarzi 2024)</a>:</strong> SVM model, 84-86% accuracy.
                    Documented exponential failure curve with dramatic increase after 40 years.
                </p>
                <p style="line-height: 1.6;">
                    <strong><a href="Research Papers/Research_Findings.md" target="_blank" style="color: #1e3c72;">Oakland Info360 Asset Validation</a>:</strong> Commercial system under EPA Consent Decree confirms
                    "If no CCTV, use Age" as primary structural failure predictor.
                </p>
            </div>
        </div>

        <div class="footer">
            <strong>Methodology:</strong> Weighted risk scoring (80% Age / 20% Material).
            Age scored via exponential curve based on Isfahan failure study.
            Material scored via comprehensive vulnerability analysis across 6 failure modes.
            <br><br>
            <strong>Model Output:</strong> 3,512 pipes scored | Risk range: 18-100 |
            Data source: LA County SSO incidents (2007-2025)
        </div>
    </div>

    <script>
        let allData = [];
        let map, markers;

        // Risk category colors
        const riskColors = {
            'Critical': '#dc3545',
            'High': '#fd7e14',
            'Medium': '#ffc107',
            'Low': '#28a745'
        };

        // Material display names
        const materialDisplayNames = {
            'VCP': 'Vitrified Clay',
            'Concrete (Reinforced)': 'Reinforced Concrete'
        };
        const getDisplayName = (mat) => materialDisplayNames[mat] || mat;

        // Helper to calculate responsive chart heights based on viewport
        const getChartHeight = (vhPercent, minPx = 250) => {
            const vh = window.innerHeight * (vhPercent / 100);
            return Math.max(vh, minPx);
        };

        // Load CSV data
        Papa.parse('sso-prediction-model/outputs/model_results.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                allData = results.data.filter(row => row.risk_score); // Remove empty rows
                console.log('Loaded', allData.length, 'records');
                initDashboard();
            },
            error: function(error) {
                document.getElementById('loading').innerHTML =
                    '<p style="color: #dc3545;">Error loading data. Make sure you\'re running a local web server.</p>' +
                    '<p style="font-size: 14px; margin-top: 10px;">Run: <code>python3 -m http.server 8000</code> then visit http://localhost:8000/dashboard.html</p>';
                console.error('Error loading CSV:', error);
            }
        });

        function initDashboard() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('overview').classList.add('active');

            updateKPIs();
            createCharts();
            initMap();
            populateMaterialFilter();
            updateTopRisks();
        }

        function updateKPIs() {
            const total = allData.length;
            const highCritical = allData.filter(d => d.risk_category === 'High' || d.risk_category === 'Critical').length;
            const avgRisk = (allData.reduce((sum, d) => sum + d.risk_score, 0) / total).toFixed(1);
            const old = allData.filter(d => d.pipe_age_years >= 70).length;

            document.getElementById('kpi-total').textContent = total.toLocaleString();
            document.getElementById('kpi-high').textContent = ((highCritical / total) * 100).toFixed(0) + '%';
            document.getElementById('kpi-avg').textContent = avgRisk;
            document.getElementById('kpi-old').textContent = ((old / total) * 100).toFixed(0) + '%';
        }

        function createCharts() {
            // Donut chart - Risk categories
            const categoryCounts = {};
            allData.forEach(d => {
                categoryCounts[d.risk_category] = (categoryCounts[d.risk_category] || 0) + 1;
            });

            // Define order: Critical to Low (top to bottom in legend)
            const categoryOrder = ['Critical', 'High', 'Medium', 'Low'];
            const orderedValues = categoryOrder.map(cat => categoryCounts[cat] || 0);
            const orderedColors = categoryOrder.map(cat => riskColors[cat]);

            const donutData = [{
                values: orderedValues,
                labels: categoryOrder,
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: orderedColors
                },
                sort: false
            }];

            Plotly.newPlot('chart-donut', donutData, {
                height: getChartHeight(35, 350),
                margin: { t: 20, b: 20, l: 40, r: 40 },
                showlegend: true
            }, {displayModeBar: false, responsive: true});

            // Material stats - used for both charts
            const materialStats = {};
            allData.forEach(d => {
                const mat = d.pipe_material_standardized || 'Unknown';
                if (!materialStats[mat]) {
                    materialStats[mat] = { count: 0, totalRisk: 0 };
                }
                materialStats[mat].count++;
                materialStats[mat].totalRisk += d.risk_score;
            });

            // Average Risk by Material bar chart
            const materialRiskData = Object.entries(materialStats)
                .map(([mat, stats]) => ({
                    material: getDisplayName(mat),
                    avgRisk: stats.totalRisk / stats.count,
                    count: stats.count
                }))
                .filter(d => d.count >= 10)  // Only show materials with 10+ incidents
                .sort((a, b) => b.avgRisk - a.avgRisk);  // Sort by risk (highest first)

            const materialBarData = [{
                x: materialRiskData.map(d => d.material),
                y: materialRiskData.map(d => d.avgRisk),
                type: 'bar',
                marker: { color: '#1e3c72' },
                hovertemplate: '%{x}: %{y:.1f}<extra></extra>'
            }];

            Plotly.newPlot('chart-material-bar', materialBarData, {
                height: getChartHeight(35, 350),
                margin: { t: 20, b: 100, l: 60, r: 60 },
                yaxis: { title: 'Avg Risk Score' },
                xaxis: { tickangle: -45 }
            }, {displayModeBar: false, responsive: true});

            // Sort by count and group small materials as "Other"
            const sortedMaterials = Object.keys(materialStats)
                .sort((a, b) => materialStats[b].count - materialStats[a].count);

            // Main materials: VCP, Concrete, Cast Iron, HDPE, Concrete (Reinforced), PVC
            // Ductile Iron, Steel, Asbestos Cement and smaller go into "Other"
            const mainMaterials = sortedMaterials.slice(0, 6);
            const otherMaterials = sortedMaterials.slice(10);
            const otherCount = otherMaterials.reduce((sum, m) => sum + materialStats[m].count, 0);

            const pieLabels = mainMaterials.map(getDisplayName);
            const pieValues = mainMaterials.map(m => materialStats[m].count);

            if (otherCount > 0) {
                pieLabels.push('Other');
                pieValues.push(otherCount);
            }

            const materialPieData = [{
                values: pieValues,
                labels: pieLabels,
                type: 'pie',
                textinfo: 'percent',
                textposition: 'inside',
                insidetextorientation: 'horizontal',
                hoverinfo: 'label+percent+value'
            }];

            Plotly.newPlot('chart-material-pie', materialPieData, {
                height: getChartHeight(40, 400),
                margin: { t: 20, b: 40, l: 40, r: 40 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.1 }
            }, {displayModeBar: false, responsive: true});

            // Line chart - Age vs Risk Score (all data, single line)
            // Sort by age and calculate average risk per age
            const ageRiskMap = {};
            allData.forEach(d => {
                const age = Math.round(d.pipe_age_years);
                if (!ageRiskMap[age]) {
                    ageRiskMap[age] = { total: 0, count: 0 };
                }
                ageRiskMap[age].total += d.risk_score;
                ageRiskMap[age].count++;
            });

            const ages = Object.keys(ageRiskMap).map(Number).sort((a, b) => a - b);
            const avgRisks = ages.map(age => ageRiskMap[age].total / ageRiskMap[age].count);

            const lineData = [{
                x: ages,
                y: avgRisks,
                mode: 'lines',
                type: 'scatter',
                line: { color: '#1e3c72', width: 2 },
                name: 'Avg Risk Score',
                hovertemplate: 'Age: %{x} years<br>Risk Score: %{y:.1f}<extra></extra>'
            }];

            Plotly.newPlot('chart-scatter', lineData, {
                height: getChartHeight(40, 350),
                margin: { t: 20, b: 60, l: 60, r: 60 },
                xaxis: { title: 'Pipe Age (years)' },
                yaxis: { title: 'Average Risk Score' }
            }, {displayModeBar: false, responsive: true});
        }

        function initMap() {
            map = L.map('map').setView([34.0522, -118.2437], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            markers = L.layerGroup().addTo(map);
            updateMapMarkers(allData);
        }

        function updateMapMarkers(data) {
            markers.clearLayers();

            data.forEach(d => {
                if (d.latitude_num && d.longitude_num) {
                    const color = riskColors[d.risk_category] || '#999';
                    const radius = Math.max(3, (d.risk_score / 100) * 10);

                    L.circleMarker([d.latitude_num, d.longitude_num], {
                        radius: radius,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        fillOpacity: 0.7
                    }).bindPopup(`
                        <strong>${d.location_name || 'Unknown Location'}</strong><br>
                        Risk Score: ${d.risk_score.toFixed(1)}<br>
                        Category: ${d.risk_category}<br>
                        Material: ${getDisplayName(d.pipe_material_standardized)}<br>
                        Age: ${d.pipe_age_years} years<br>
                        Rank: ${d.risk_rank}
                    `).addTo(markers);
                }
            });
        }

        function populateMaterialFilter() {
            const materials = [...new Set(allData.map(d => d.pipe_material_standardized))].sort();
            const select = document.getElementById('map-filter-material');
            materials.forEach(mat => {
                const option = document.createElement('option');
                option.value = mat;
                option.textContent = getDisplayName(mat);
                select.appendChild(option);
            });
        }

        function filterMap() {
            const riskFilter = document.getElementById('map-filter-risk').value;
            const materialFilter = document.getElementById('map-filter-material').value;
            const scoreFilter = parseFloat(document.getElementById('map-filter-score').value) || 0;

            let filtered = allData;

            if (riskFilter !== 'all') {
                filtered = filtered.filter(d => d.risk_category === riskFilter);
            }
            if (materialFilter !== 'all') {
                filtered = filtered.filter(d => d.pipe_material_standardized === materialFilter);
            }
            filtered = filtered.filter(d => d.risk_score >= scoreFilter);

            updateMapMarkers(filtered);
        }

        function updateTopRisks() {
            const n = parseInt(document.getElementById('top-n').value);
            const sorted = [...allData].sort((a, b) => b.risk_score - a.risk_score).slice(0, n);

            const tbody = document.getElementById('risks-tbody');
            tbody.innerHTML = sorted.map(d => `
                <tr>
                    <td>${d.risk_rank}</td>
                    <td>${d.location_name || 'Unknown'}</td>
                    <td>${d.city || '-'}</td>
                    <td>${getDisplayName(d.pipe_material_standardized)}</td>
                    <td>${d.pipe_age_years} yrs</td>
                    <td><strong>${d.risk_score.toFixed(1)}</strong></td>
                    <td><span class="badge badge-${d.risk_category.toLowerCase()}">${d.risk_category}</span></td>
                    <td>${d.spill_date || '-'}</td>
                </tr>
            `).join('');
        }

        function showPage(pageName) {
            // Update nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update pages
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));

            if (pageName === 'overview') {
                document.getElementById('overview').classList.add('active');
            } else if (pageName === 'map') {
                document.getElementById('mapPage').classList.add('active');
                setTimeout(() => map.invalidateSize(), 100);
            } else if (pageName === 'risks') {
                document.getElementById('risksPage').classList.add('active');
            } else if (pageName === 'methodology') {
                document.getElementById('methodology').classList.add('active');
            }
        }
    </script>
</body>
</html>
